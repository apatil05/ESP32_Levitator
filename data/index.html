<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ONDA</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ---------- BACKGROUND ---------- */
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Orbitron', sans-serif;
      color: #e0faff;
      background: linear-gradient(180deg, #000814 0%, #001f3f 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .background {
      position: fixed;
      inset: 0;
      overflow: hidden;
      z-index: 0;
    }

    .wave {
      position: absolute;
      bottom: 0;
      width: 200%;
      height: 250px;
      border-radius: 1000px 1000px 0 0;
      filter: blur(25px);
      opacity: 0.6;
      animation: waveMotion 12s infinite linear;
    }

    .wave:nth-child(1) {
      background: rgba(0, 255, 204, 0.35);
      animation-duration: 12s;
    }

    .wave:nth-child(2) {
      background: rgba(0, 150, 255, 0.3);
      animation-duration: 15s;
    }

    .wave:nth-child(3) {
      background: rgba(157, 0, 255, 0.25);
      animation-duration: 20s;
    }

    @keyframes waveMotion {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    .wave.boosted {
      filter: blur(15px);
      opacity: 0.9;
      animation-duration: 6s !important;
      transform: scale(1.05);
    }

    /* ---------- TITLE ---------- */
    h1 {
      position: relative;
      z-index: 2;
      font-size: 4rem;
      font-weight: 900;
      color: #00ffff;
      letter-spacing: 0.7em;
      text-shadow:
        0 0 20px #00ffff,
        0 0 40px #0077ff,
        0 0 80px #9d00ff,
        0 0 100px #00ffff;
      animation: titlePulse 3s infinite ease-in-out;
      margin-bottom: 3rem;
      margin-top: 2rem;
    }

    @keyframes titlePulse {
      0%, 100% {
        text-shadow:
          0 0 20px #00ffff,
          0 0 40px #0077ff,
          0 0 80px #9d00ff,
          0 0 100px #00ffff;
      }
      50% {
        text-shadow:
          0 0 40px #00e1ff,
          0 0 60px #00ffff,
          0 0 100px #b700ff,
          0 0 120px #00ffff;
      }
    }

    /* ---------- BALL ---------- */
    #ball {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffffff, #83866b);
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 35%;
      transition: top 0.2s ease-out, box-shadow 0.3s ease-out, transform 0.2s;
      box-shadow: none;
      z-index: 2;
    }

    #ball.active-glow {
      box-shadow:
        0 0 30px rgba(0, 255, 255, 0.9),
        0 0 60px rgba(0, 119, 255, 0.8),
        0 0 90px rgba(157, 0, 255, 0.7);
      transform: translateX(-50%) scale(1.1);
    }

    /* ---------- CONTAINER ---------- */
    .container {
      position: relative;
      width: 22rem;
      height: 22rem;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 1rem;
      backdrop-filter: blur(8px);
      background: rgba(255, 255, 255, 0.03);
      overflow: hidden;
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.1);
      margin: 0 auto;
      z-index: 2;
    }

    /* ---------- PHASE DISPLAY ---------- */
    .phase-display {
      position: relative;
      z-index: 3;
      margin-top: 1.5rem;
      font-size: 1.5rem;
      font-weight: 600;
      color: #00ffff;
      text-shadow: 0 0 10px #00ffff;
      font-family: 'Orbitron', monospace;
      letter-spacing: 0.1em;
      transition: transform 0.15s ease-out;
    }
    
  </style>
</head>

<body class="flex flex-col items-center justify-center min-h-screen text-center">

  <!-- Animated background -->
  <div class="background">
    <div class="wave"></div>
    <div class="wave"></div>
    <div class="wave"></div>
  </div>

  <!-- Title -->
  <h1>O&nbsp;&nbsp;N&nbsp;&nbsp;D&nbsp;&nbsp;A</h1>

  <!-- Container -->
  <div class="container">
    <div id="ball"></div>
  </div>

  <!-- Phase Display -->
  <div class="phase-display" id="phaseDisplay">0.0°</div>

  <!-- JS Logic -->
  <script>
    const ball = document.getElementById('ball');
    const container = ball.parentElement;
    const waves = document.querySelectorAll('.wave');

    let isDragging = false;
    let startY = 0;
    let startTop = 0;
    let lastSentPhase = -1;

    function moveBallTo(yPercent) {
      const clamped = Math.min(65, Math.max(6, yPercent));
      ball.style.top = clamped + '%';
      activateGlow();
      const phase = clampedToPhase(clamped);
      sendPhase(phase);
      
      // Update visual feedback with current phase
      updatePhaseDisplay(phase);
    }

    function updatePhaseDisplay(phase) {
      // Update the phase display element
      const display = document.getElementById('phaseDisplay');
      if (display) {
        display.textContent = phase.toFixed(1) + '°';
        // Add a subtle pulse effect when phase changes
        display.style.transform = 'scale(1.1)';
        setTimeout(() => {
          display.style.transform = 'scale(1.0)';
        }, 150);
      }
    }

    // Initialize phase display
    const phaseDisplay = document.getElementById('phaseDisplay');
    if (phaseDisplay) {
      window.phaseDisplay = phaseDisplay;
      updatePhaseDisplay(0);
    }

    function clampedToPhase(clamped) {
      // Map Y% (6–65%) → phase 0–360° for full range control
      // Use decimal precision for smooth, continuous phase shifts
      return ((clamped - 6) / (65 - 6)) * 360.0;
    }

    // Throttle function to limit request rate while keeping smooth updates
    let phaseUpdateTimeout = null;
    let pendingPhase = null;

    function sendPhase(deg) {
      // Store the latest phase value
      pendingPhase = deg;
      
      // Clear any pending timeout
      if (phaseUpdateTimeout) {
        clearTimeout(phaseUpdateTimeout);
      }
      
      // Send immediately if it's been a while, otherwise throttle
      const timeSinceLastSend = Date.now() - (sendPhase.lastSendTime || 0);
      if (timeSinceLastSend > 50) { // Send immediately if >50ms since last
        actuallySendPhase(deg);
      } else {
        // Throttle: send after a short delay, but only the latest value
        phaseUpdateTimeout = setTimeout(() => {
          if (pendingPhase !== null) {
            actuallySendPhase(pendingPhase);
            pendingPhase = null;
          }
        }, 20); // Send at most every 20ms (50 updates/sec)
      }
    }

    function actuallySendPhase(deg) {
      // Only send if phase changed significantly (0.1° threshold for smoothness)
      if (Math.abs(deg - lastSentPhase) < 0.1) return;
      lastSentPhase = deg;
      sendPhase.lastSendTime = Date.now();

      // Send with 2 decimal precision for fine control
      fetch(`/set_phase?deg=${deg.toFixed(2)}`)
        .then(r => r.json())
        .then(d => {
          console.log("Phase set to", parseFloat(d.phase).toFixed(2) + "°");
        })
        .catch(e => console.error("Error sending phase:", e));
    }

    function activateGlow() {
      ball.classList.add('active-glow');
      waves.forEach(w => w.classList.add('boosted'));
      clearTimeout(ball.glowTimeout);
      ball.glowTimeout = setTimeout(() => {
        ball.classList.remove('active-glow');
        waves.forEach(w => w.classList.remove('boosted'));
      }, 400);
    }

    function startDrag(e) {
      isDragging = true;
      startY = e.touches ? e.touches[0].clientY : e.clientY;
      startTop = parseFloat(getComputedStyle(ball).top) / container.clientHeight * 100;
      activateGlow();
    }

    function onDrag(e) {
      if (!isDragging) return;
      const currentY = e.touches ? e.touches[0].clientY : e.clientY;
      const delta = (currentY - startY) / container.clientHeight * 100;
      moveBallTo(startTop + delta);
    }

    function endDrag() {
      isDragging = false;
      ball.classList.remove('active-glow');
      waves.forEach(w => w.classList.remove('boosted'));
    }

    document.addEventListener('keydown', (e) => {
      let current = parseFloat(getComputedStyle(ball).top) / container.clientHeight * 100;
      if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
        // Finer keyboard control (1% increments instead of 5%)
        const increment = 1.0; // 1% = ~6° phase shift
        if (e.key === 'ArrowUp') moveBallTo(current - increment);
        if (e.key === 'ArrowDown') moveBallTo(current + increment);
        e.preventDefault(); // Prevent page scrolling
      }
    });

    ball.addEventListener('mousedown', startDrag);
    ball.addEventListener('touchstart', startDrag);
    window.addEventListener('mousemove', onDrag);
    window.addEventListener('touchmove', onDrag);
    window.addEventListener('mouseup', endDrag);
    window.addEventListener('touchend', endDrag);
  </script>
</body>
</html>
